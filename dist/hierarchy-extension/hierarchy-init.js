"use strict";!function(){function e(e){const t=new Map;let n="",i="scene";return{add(n){var i;if(t.has(n.id))throw new Error(`Extension with id ${n.id} already exists`);t.set(n.id,n),window.utils.log(window.utils.LogLevel.WARN,"Extension",`添加扩展: ${n.id}`),null===(i=e.events)||void 0===i||i.emit("extensionAdded",n),this.updateAll()},get:e=>t.get(e),remove(n){var i,o;const l=t.get(n);l&&(null===(i=l.onDestroy)||void 0===i||i.call(l),t.delete(n),window.utils.log(window.utils.LogLevel.WARN,"Extension",`移除扩展: ${n}`),null===(o=e.events)||void 0===o||o.emit("extensionRemoved",n))},getAll:()=>Array.from(t.values()),updateAll(){var o;if(!e.vue||!e.tree)return void window.utils.log(window.utils.LogLevel.ERROR,"Extension","更新取消: manager未就绪");(function(){var t,o,l;if(!(null===(o=null===(t=e.vue)||void 0===t?void 0:t.nodes)||void 0===o?void 0:o.length))return!!n&&(n="",i="scene",!0);const r=e.vue.nodes[0],s=e.getNode(r.uuid);if(!s)return!1;const d="cc.Scene"===s.type?s.uuid:(null===(l=s.prefab)||void 0===l?void 0:l.assetUuid)||"",u="cc.Scene"===s.type?"scene":"prefab";return d!==n&&(n=d,i=u,!0)})(e.vue)&&(null===(o=e.events)||void 0===o||o.emit("assetChange",n,i));const l=Array.from(t.values()).sort(((e,t)=>(t.priority||0)-(e.priority||0)));for(const t of e.tree.nodeMap.keys()){const n=e.getNode(t),i=e.getVueComponent(t);if(!n||!i)continue;const o=i.$el;if(!o)continue;let r=o.querySelector(".hierarchy-extension-container");r||(o.style.position="relative",r=document.createElement("div"),r.className="hierarchy-extension-container",r.style.cssText="\n                            position: absolute;\n                            left: 0;\n                            top: 0;\n                            width: 100%;\n                            height: 100%;\n                            pointer-events: none;\n                            z-index: 999;\n                        ",o.appendChild(r)),l.forEach((e=>{var t,i,o,l;null===(i=null===(t=e.isVisible)||void 0===t?void 0:t.call(e,n))||void 0===i||i?r&&(null===(l=e.onCreate)||void 0===l||l.call(e,n,r)):null===(o=e.onDestroy)||void 0===o||o.call(e,n)}))}},clear(){Array.from(t.keys()).forEach((e=>this.remove(e)))}}}function t(){return{vue:null,tree:null,events:null,extension:null,refresh:window.utils.debounce((function(){this._doRefresh()}),50),_doRefresh(){var e,t,n;if(window.utils.log(window.utils.LogLevel.INFO,"Hierarchy","开始刷新"),!this.vue||!this.tree)return;this.tree.clear();const i=[...this.vue.nodes];for(const e of i)this.tree.addNode(e);for(const t of i){const n=this.getVueComponent(t.uuid);n&&(t.vueComponent=n,window.utils.log(window.utils.LogLevel.DEBUG,"Hierarchy","处理节点:",{name:t.name,path:t.path,depth:t.depth,uuid:t.uuid,element:(null===(e=n.$el)||void 0===e?void 0:e.outerHTML)||"未找到元素"}))}null===(t=this.events)||void 0===t||t.emit("treeUpdate"),null===(n=this.extension)||void 0===n||n.updateAll()},getNodeHierarchyInfo(e){return{name:e.name,type:e.type,children:e.children.map((e=>this.getNodeHierarchyInfo(e)))}},getElement(e){var t;return null===(t=this.getVueComponent(e))||void 0===t?void 0:t.$el},getVueComponent(e){var t;if(null===(t=this.vue)||void 0===t?void 0:t.$children)return this.vue.$children.find((t=>t.$props.node.uuid===e))},getNode(e){var t;return null===(t=this.tree)||void 0===t?void 0:t.getNode(e)},init(){var t;const n=function(){var e,t;const n=document.getElementsByTagName("dock-frame")[0];if(!(null==n?void 0:n.shadowRoot))return window.utils.log(window.utils.LogLevel.WARN,"Hierarchy","未找到dock-frame"),null;const i=n.shadowRoot.querySelectorAll("panel-frame"),o=Array.from(i).find((e=>"hierarchy"===e.getAttribute("name")));if(!(null==o?void 0:o.shadowRoot))return window.utils.log(window.utils.LogLevel.WARN,"Hierarchy","未找到hierarchy面板"),null;const l=o.shadowRoot.querySelector("ui-drag-area");if(!l)return window.utils.log(window.utils.LogLevel.WARN,"Hierarchy","未找到drag-area"),null;const r=l.__vue__;return r?(null===(e=r.nodes)||void 0===e?void 0:e.length)?(window.utils.log(window.utils.LogLevel.DEBUG,"Hierarchy","场景结构:",r.nodes.map((e=>{var t;return{name:e.name,type:e.type,depth:e.depth,path:e.path,children:(null===(t=e.children)||void 0===t?void 0:t.length)||0}}))),window.utils.log(window.utils.LogLevel.DEBUG,"Hierarchy","Vue组件节点数据:",null===(t=r.$children)||void 0===t?void 0:t.map((e=>({name:e.$props.node.name,uuid:e.$props.node.uuid,type:e.$props.node.type,path:e.$props.node.path,depth:e.$props.node.depth,element:e.$el.outerHTML,"完整节点":e.$props.node})))),r):(window.utils.log(window.utils.LogLevel.WARN,"Hierarchy","节点数据未加载"),null):(window.utils.log(window.utils.LogLevel.WARN,"Hierarchy","未找到Vue实例"),null)}();return!!n&&(this.vue=n,this.tree=function(){const e=new Map;return{nodeMap:e,clear(){e.clear()},getNode:t=>e.get(t),addNode(t){if(t.children||(t.children=[]),e.set(t.uuid,t),t.parent){const n=e.get(t.parent);n&&n.children.push(t)}},removeNode(t){const n=e.get(t);if(n){if(n.parent){const i=e.get(n.parent);i&&(i.children=i.children.filter((e=>e.uuid!==t)))}n.children.forEach((e=>this.removeNode(e.uuid))),e.delete(t)}},getNodeCount:()=>e.size}}(),this.events=function(){const e=new Map;return{listeners:new Map,emit(t,...n){[...e.get(t)||[]].sort(((e,t)=>{var n,i;return((null===(n=t.options)||void 0===n?void 0:n.priority)||0)-((null===(i=e.options)||void 0===i?void 0:i.priority)||0)})).forEach((({callback:e,options:i})=>{try{e(...n)}catch(e){window.utils.log(window.utils.LogLevel.ERROR,"Events",`事件处理错误 [${String(t)}]:`,e)}(null==i?void 0:i.once)&&this.off(t,e)}))},on(t,n,i){e.has(t)||e.set(t,[]),e.get(t).push({callback:n,options:i}),this.listeners.has(t)||this.listeners.set(t,[]),this.listeners.get(t).push(n)},off(t,n){const i=e.get(t);if(i){const e=i.findIndex((e=>e.callback===n));e>-1&&i.splice(e,1)}const o=this.listeners.get(t);if(o){const e=o.indexOf(n);e>-1&&o.splice(e,1)}},clear(){e.clear(),this.listeners.clear()}}}(),this.extension=e(this),this.vue.$watch("nodes",(()=>{this.refresh()})),this.refresh(),null===(t=this.events)||void 0===t||t.emit("initialized"),!0)},destroy(){var e,t,n,i;null===(e=this.extension)||void 0===e||e.clear(),null===(t=this.events)||void 0===t||t.emit("destroy"),null===(n=this.events)||void 0===n||n.clear(),null===(i=this.tree)||void 0===i||i.clear(),this.vue=null,this.tree=null,this.events=null,this.extension=null},cleanup(){var e,t,n,i,o;if(null===(e=this.extension)||void 0===e||e.clear(),null===(t=this.events)||void 0===t||t.emit("destroy"),null===(n=this.events)||void 0===n||n.clear(),null===(i=this.tree)||void 0===i||i.clear(),null===(o=this.vue)||void 0===o?void 0:o.$el){this.vue.$el.querySelectorAll('[class*="hierarchy-"]').forEach((e=>e.remove()))}this.vue=null,this.tree=null,this.events=null,this.extension=null,window.hierarchy=null}}}window.utils.exponentialRetry((async()=>{const e=t();if(!e.init())throw new Error("初始化失败：未找到层级面板");window.hierarchy=e,window.utils.log(window.utils.LogLevel.INFO,"Hierarchy","初始化成功")}),100,1e3).catch((e=>{throw window.utils.log(window.utils.LogLevel.ERROR,"Hierarchy","初始化失败:",e),e}))}();
