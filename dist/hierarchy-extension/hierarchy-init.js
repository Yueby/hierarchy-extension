"use strict";!function(){function e(e){const n=new Map;let t="",l="scene",o=null;return{add(t){var l,o,i,r;if(n.has(t.id))throw new Error(`Extension with id ${t.id} already exists`);!function(n,t,l){var o;if(!l||!(null===(o=e.vue)||void 0===o?void 0:o.$el))return;const i=`hierarchy-style-${n}`;let r=document.getElementById(i);r||(r=document.createElement("style"),r.id=i,e.vue.$el.appendChild(r)),r.textContent=l}(t.id,t.className,t.style),null===(o=null===(l=t.lifecycle)||void 0===l?void 0:l.onInit)||void 0===o||o.call(l),(null===(i=t.lifecycle)||void 0===i?void 0:i.onAssetChange)&&e.events&&e.events.on("assetChange",t.lifecycle.onAssetChange);const s=Object.assign(Object.assign({},t),{destroy:()=>{var l,o,i,r;null===(o=null===(l=t.lifecycle)||void 0===l?void 0:l.onDestroy)||void 0===o||o.call(l),(null===(i=t.lifecycle)||void 0===i?void 0:i.onAssetChange)&&e.events&&e.events.off("assetChange",t.lifecycle.onAssetChange),function(e){const n=document.getElementById(`hierarchy-style-${e}`);null==n||n.remove()}(t.id),n.delete(t.id),null===(r=e.events)||void 0===r||r.emit("extensionRemoved",t.id)}});return n.set(t.id,s),null===(r=e.events)||void 0===r||r.emit("extensionAdded",s),this.updateAll(),s},get:e=>n.get(e),remove(e){const t=n.get(e);null==t||t.destroy()},getAll:()=>Array.from(n.values()),updateAll(){var i,r;if(o||!e.vue)return;const s=e.vue;(function(e){var n,o;if(!(null===(n=null==e?void 0:e.nodes)||void 0===n?void 0:n.length))return!!t&&(t="",l="scene",!0);const i=e.nodes[0],r="cc.Scene"===i.type?i.uuid:(null===(o=i.prefab)||void 0===o?void 0:o.assetUuid)||"",s="cc.Scene"===i.type?"scene":"prefab";return r!==t&&(t=r,l=s,!0)})(s)&&(null===(i=e.events)||void 0===i||i.emit("assetChange",t,l)),s.$children.forEach((e=>{const t=e.$el;n.forEach((n=>{const l=n.isVisible(e);let o=t.querySelector(`.${n.className}`);l?(l&&!o&&(o=document.createElement("div"),o.className=n.className,t.appendChild(o),n.onCreate(e,o)),o&&n.onUpdate&&n.onUpdate(e,o)):null==o||o.remove()}))})),o=setTimeout((()=>{o=null}),0),null===(r=e.events)||void 0===r||r.emit("treeUpdate")},clear(){Array.from(n.keys()).forEach((e=>this.remove(e)))}}}function n(){return{vue:null,tree:null,events:null,extension:null,refresh(){var e,n,t;if(this.vue&&this.tree)if(console.log("[Hierarchy] 开始刷新节点树"),null===(e=this.vue.nodes)||void 0===e?void 0:e.length){this.tree.clear();for(const e of this.vue.nodes){const n=this.vue.$children.find((n=>{var t;const l=n.$el;return((null===(t=null==l?void 0:l.dataset)||void 0===t?void 0:t.uuid)||n.uuid)===e.uuid}));if(!n){console.warn("[Hierarchy] 未找到节点组件:",{uuid:e.uuid,name:e.name,availableChildren:this.vue.$children.map((e=>{var n,t;return{uuid:e.uuid,elUuid:null===(t=null===(n=e.$el)||void 0===n?void 0:n.dataset)||void 0===t?void 0:t.uuid}}))});continue}const t={uuid:e.uuid,name:e.name,type:e.type,parent:e.parent,active:e.active,prefab:e.prefab,element:n.$el,vueComponent:n};console.log("[Hierarchy] 添加节点:",{uuid:t.uuid,name:t.name,type:t.type,hasElement:!!t.element,hasVueComponent:!!t.vueComponent}),this.tree.addNode(t)}console.log("[Hierarchy] 刷新完成:",{nodes:this.tree.nodeMap.size,roots:this.tree.rootNodes.length,firstNode:null===(n=this.tree.rootNodes[0])||void 0===n?void 0:n.name}),null===(t=this.events)||void 0===t||t.emit("treeUpdate")}else console.warn("[Hierarchy] 无节点数据")},init(){var n,t;const l=function(){var e;const n=document.getElementsByTagName("dock-frame")[0];if(!(null==n?void 0:n.shadowRoot))return console.warn("[Hierarchy] 未找到dock-frame"),null;const t=n.shadowRoot.querySelectorAll("panel-frame"),l=Array.from(t).find((e=>"hierarchy"===e.getAttribute("name")));if(!(null==l?void 0:l.shadowRoot))return console.warn("[Hierarchy] 未找到hierarchy面板"),null;const o=l.shadowRoot.querySelector("ui-drag-area");if(!o)return console.warn("[Hierarchy] 未找到drag-area"),null;const i=o.__vue__;return i?(null===(e=i.nodes)||void 0===e?void 0:e.length)?(console.log("[Hierarchy] 节点数据:",{nodes:i.nodes.map((e=>({uuid:e.uuid,name:e.name,type:e.type,parent:e.parent}))),children:i.$children.map((e=>({uuid:e.uuid,el:!!e.$el})))}),i):(console.warn("[Hierarchy] 节点数据未加载"),null):(console.warn("[Hierarchy] 未找到Vue实例"),null)}();return!!l&&(this.vue=l,this.tree=function(){const e=new Map,n=[];return{nodeMap:e,rootNodes:n,getChildren:n=>Array.from(e.values()).filter((e=>e.parent===n)),getParent(n){const t=e.get(n);return t&&e.get(t.parent)||null},isParent(n,t){let l=e.get(n);for(;l;){if(l.parent===t)return!0;l=e.get(l.parent)}return!1},clear(){e.clear(),n.length=0},addNode(t){e.set(t.uuid,t),t.parent||n.push(t)},removeNode(t){const l=e.get(t);if(l){e.delete(t);const o=n.indexOf(l);o>-1&&n.splice(o,1)}}}}(),this.events=function(){const e=new Map;return{listeners:e,emit(n,...t){(e.get(n)||[]).forEach((e=>e(...t)))},on(n,t){e.has(n)||e.set(n,[]),e.get(n).push(t)},off(n,t){const l=e.get(n);if(l){const e=l.indexOf(t);e>-1&&l.splice(e,1)}},clear(){e.clear()}}}(),this.extension=e(this),this.vue.$watch("nodes",(()=>{var e;this.refresh(),null===(e=this.extension)||void 0===e||e.updateAll()})),this.refresh(),null===(n=this.extension)||void 0===n||n.updateAll(),null===(t=this.events)||void 0===t||t.emit("initialized"),!0)},destroy(){var e,n,t,l;null===(e=this.extension)||void 0===e||e.clear(),null===(n=this.events)||void 0===n||n.emit("destroy"),null===(t=this.events)||void 0===t||t.clear(),null===(l=this.tree)||void 0===l||l.clear(),this.vue=null,this.tree=null,this.events=null,this.extension=null}}}new Promise(((e,t)=>{let l=0;const o=setInterval((()=>{console.log(`[Hierarchy] 尝试初始化... (${l+1}/50)`);const i=n();if(i.init())return window.hierarchy=i,clearInterval(o),console.log("[Hierarchy] 初始化成功"),void e();if(++l>=50){clearInterval(o);const e=new Error("层级管理器初始化超时");console.error("[Hierarchy] 初始化失败:",e),t(e)}}),200)}))}();
