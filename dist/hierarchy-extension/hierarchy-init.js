"use strict";!async function(){let e;function n(e){const n=new Map;let t="",i="scene";return{add(t){var i;if(n.has(t.id))throw new Error(`Extension with id ${t.id} already exists`);n.set(t.id,t),console.info("[hierarchy-extension]","添加扩展:",t.id),null===(i=e.events)||void 0===i||i.emit("extensionAdded",t),this.updateAll()},get:e=>n.get(e),remove(t){var i,o;const r=n.get(t);r&&(null===(i=r.onDestroy)||void 0===i||i.call(r),n.delete(t),console.info("[hierarchy-extension]","移除扩展:",t),null===(o=e.events)||void 0===o||o.emit("extensionRemoved",t))},getAll:()=>Array.from(n.values()),updateAll(){var o;if(!e.vue||!e.tree)return void console.error("[hierarchy-extension]","更新取消: manager未就绪");(function(){var n,o,r;if(!(null===(o=null===(n=e.vue)||void 0===n?void 0:n.nodes)||void 0===o?void 0:o.length))return!!t&&(t="",i="scene",!0);const l=e.vue.nodes[0],s=e.getNode(l.uuid);if(!s)return!1;const a="cc.Scene"===s.type?s.uuid:(null===(r=s.prefab)||void 0===r?void 0:r.assetUuid)||"",c="cc.Scene"===s.type?"scene":"prefab";return a!==t&&(t=a,i=c,!0)})(e.vue)&&(null===(o=e.events)||void 0===o||o.emit("assetChange",t,i));const r=Array.from(n.values()).sort(((e,n)=>(n.priority||0)-(e.priority||0)));for(const n of e.tree.nodeMap.keys()){const t=e.getNode(n),i=e.getVueComponent(n);if(!t||!i)continue;const o=i.$el;if(!o)continue;let l=o.querySelector(".hierarchy-extension-container");l||(o.style.position="relative",l=document.createElement("div"),l.className="hierarchy-extension-container",l.style.cssText="\n                            position: absolute;\n                            left: 0;\n                            top: 0;\n                            width: 100%;\n                            height: 100%;\n                            pointer-events: none;\n                            z-index: 999;\n                        ",o.appendChild(l)),r.forEach((e=>{var n,i,o,r;null===(i=null===(n=e.isVisible)||void 0===n?void 0:n.call(e,t))||void 0===i||i?l&&(null===(r=e.onCreate)||void 0===r||r.call(e,t,l)):null===(o=e.onDestroy)||void 0===o||o.call(e,t)}))}},clear(){Array.from(n.keys()).forEach((e=>this.remove(e)))}}}function t(){return{vue:null,tree:null,events:null,extension:null,refresh:window.utils.debounce((function(){this._doRefresh()}),50),_doRefresh(){var e,n;if(!this.vue||!this.tree)return;this.tree.clear();const t=[...this.vue.nodes];for(const e of t)this.tree.addNode(e);for(const e of t){const n=this.getVueComponent(e.uuid);n&&(e.vueComponent=n)}null===(e=this.events)||void 0===e||e.emit("treeUpdate"),null===(n=this.extension)||void 0===n||n.updateAll()},getNodeHierarchyInfo(e){return{name:e.name,type:e.type,children:e.children.map((e=>this.getNodeHierarchyInfo(e)))}},getElement(e){var n;return null===(n=this.getVueComponent(e))||void 0===n?void 0:n.$el},getVueComponent(e){var n;if(null===(n=this.vue)||void 0===n?void 0:n.$children)return this.vue.$children.find((n=>n.$props.node.uuid===e))},getNode(e){var n;return null===(n=this.tree)||void 0===n?void 0:n.getNode(e)},init(){var e;const t=function(){var e;const n=document.getElementsByTagName("dock-frame")[0];if(!(null==n?void 0:n.shadowRoot))return console.warn("[hierarchy]","未找到dock-frame"),null;const t=n.shadowRoot.querySelectorAll("panel-frame"),i=Array.from(t).find((e=>"hierarchy"===e.getAttribute("name")));if(!(null==i?void 0:i.shadowRoot))return console.warn("[hierarchy]","未找到hierarchy面板"),null;const o=i.shadowRoot.querySelector("ui-drag-area");if(!o)return console.warn("[hierarchy]","未找到drag-area"),null;const r=o.__vue__;return r?(null===(e=r.nodes)||void 0===e?void 0:e.length)?r:null:(console.warn("[hierarchy]","未找到Vue实例"),null)}();return!!t&&(this.vue=t,this.tree=function(){const e=new Map;return{nodeMap:e,clear(){e.clear()},getNode:n=>e.get(n),addNode(n){if(n.children||(n.children=[]),e.set(n.uuid,n),n.parent){const t=e.get(n.parent);t&&t.children.push(n)}},removeNode(n){const t=e.get(n);if(t){if(t.parent){const i=e.get(t.parent);i&&(i.children=i.children.filter((e=>e.uuid!==n)))}t.children.forEach((e=>this.removeNode(e.uuid))),e.delete(n)}},getNodeCount:()=>e.size}}(),this.events=function(){const e=new Map;return{listeners:new Map,emit(n,...t){[...e.get(n)||[]].sort(((e,n)=>{var t,i;return((null===(t=n.options)||void 0===t?void 0:t.priority)||0)-((null===(i=e.options)||void 0===i?void 0:i.priority)||0)})).forEach((({callback:e,options:i})=>{try{e(...t)}catch(e){console.error("[hierarchy-events]","事件处理错误:",String(n),e)}(null==i?void 0:i.once)&&this.off(n,e)}))},on(n,t,i){e.has(n)||e.set(n,[]),e.get(n).push({callback:t,options:i}),this.listeners.has(n)||this.listeners.set(n,[]),this.listeners.get(n).push(t)},off(n,t){const i=e.get(n);if(i){const e=i.findIndex((e=>e.callback===t));e>-1&&i.splice(e,1)}const o=this.listeners.get(n);if(o){const e=o.indexOf(t);e>-1&&o.splice(e,1)}},clear(){e.clear(),this.listeners.clear()}}}(),this.extension=n(this),this.vue.$watch("nodes",(()=>{this.refresh()})),this.refresh(),null===(e=this.events)||void 0===e||e.emit("initialized"),!0)},destroy(){var e,n,t,i;null===(e=this.extension)||void 0===e||e.clear(),null===(n=this.events)||void 0===n||n.emit("destroy"),null===(t=this.events)||void 0===t||t.clear(),null===(i=this.tree)||void 0===i||i.clear(),this.vue=null,this.tree=null,this.events=null,this.extension=null},cleanup(){var e,n,t,i,o;if(null===(e=this.extension)||void 0===e||e.clear(),null===(n=this.events)||void 0===n||n.emit("destroy"),null===(t=this.events)||void 0===t||t.clear(),null===(i=this.tree)||void 0===i||i.clear(),null===(o=this.vue)||void 0===o?void 0:o.$el){this.vue.$el.querySelectorAll('[class*="hierarchy-"]').forEach((e=>e.remove()))}this.vue=null,this.tree=null,this.events=null,this.extension=null,window.hierarchy=null}}}window.hierarchyReady=new Promise((n=>{e=n}));try{await async function(n=5,i=500){let o=0;for(;o<n;){try{const n=t();if(n.init())return window.hierarchy=n,void e(!0)}catch(e){0===o&&console.warn("[hierarchy]","初始化尝试失败:",e)}o++,o<n&&await new Promise((e=>setTimeout(e,i)))}console.warn("[hierarchy]","初始化未成功: 等待场景准备好后再次尝试"),e(!1)}(5,500)}catch(e){console.error("[hierarchy]","初始化过程中断:",e)}}();
